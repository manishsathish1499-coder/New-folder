import sqlite3
import hashlib

# ----------------------------
# DATABASE CONNECTION
# ----------------------------
def connect_db():
    return sqlite3.connect("users.db")

# ----------------------------
# SECURE PASSWORD HASHING
# ----------------------------
def hash_password(password):
    return hashlib.sha256(password.encode()).hexdigest()

# ----------------------------
# USER REGISTRATION
# ----------------------------
def register_user(username, password):
    if len(username) < 4 or len(password) < 6:
        print("Username or password too short")
        return

    conn = connect_db()
    cursor = conn.cursor()

    cursor.execute("""
        CREATE TABLE IF NOT EXISTS users(
            id INTEGER PRIMARY KEY AUTOINCREMENT,
            username TEXT UNIQUE,
            password TEXT
        )
    """)

    try:
        cursor.execute("INSERT INTO users(username,password) VALUES (?,?)",
                       (username, hash_password(password)))
        conn.commit()
        print("User registered successfully")
    except sqlite3.IntegrityError:
        print("Username already exists")

    conn.close()

# ----------------------------
# LOGIN AUTHENTICATION
# ----------------------------
def login_user(username, password):
    conn = connect_db()
    cursor = conn.cursor()

    cursor.execute("SELECT password FROM users WHERE username=?", (username,))
    result = cursor.fetchone()

    if result and result[0] == hash_password(password):
        print("Login successful")
    else:
        print("Invalid username or password")

    conn.close()

# ----------------------------
# MAIN MENU
# ----------------------------
def main():
    while True:
        print("\n1. Register")
        print("2. Login")
        print("3. Exit")

        choice = input("Enter choice: ")

        if choice == "1":
            u = input("Username: ")
            p = input("Password: ")
            register_user(u, p)

        elif choice == "2":
            u = input("Username: ")
            p = input("Password: ")
            login_user(u, p)

        elif choice == "3":
            print("Goodbye!")
            break

        else:
            print("Invalid choice")

if __name__ == "__main__":
    main()
